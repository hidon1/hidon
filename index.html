<!DOCTYPE html>
<html lang="he">
<head>
    <style>
        body {
            visibility: hidden;
        }
    </style>

    <link rel="stylesheet" href="mobile_friendly_style_with_comment.css">
    <link href="https://fonts.googleapis.com/css2?family=Alef:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Dirt&display=swap" rel="stylesheet">
    <style>
        #welcomeBanner {
            position: fixed;
            top: 6vh;
            left: 50%;
            transform: translateX(-50%);
            width: 96vw;
            min-width: 220px;
            max-width: 900px;
            z-index: 3000;
            background-color: #AFEEEE; /* 专拽 专 */
            color: #003366; /*   */
            font-family: 'Rubik Dirt', cursive;
            font-size: 4.5rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-align: center;
            border-radius: 50px;
            box-shadow: 0 8px 38px #7b60c357;
            padding: 38px 12px 22px 12px;
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.6s cubic-bezier(.84, -0.15, .57, .87);
            border: 4px solid #7657c2;
            line-height: 1.16;
            user-select: none;
        }

        #welcomeBanner.hide {
            opacity: 0;
            pointer-events: none;
        }
    </style>
    <style>
        #successMessage {
            position: fixed;
            top: 12vh; /* 砖砖 注 驻转  转专 */
            left: 50%;
            transform: translateX(-50%);
            font-size: 5rem;
            color: #0047ab;
            font-family: 'Frank Ruhl Libre', sans-serif;
            letter-spacing: 0.12em;
            text-align: center;
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            margin: 0;
            display: none;
            z-index: 9999;
            user-select: none;
            line-height: 1.08;
            white-space: nowrap; /* 砖专 转  */
        }
    </style>

    <div id="successMessage">  注专转 爪</div>


    <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .button, #retryBtn, #startBtn, #nextStageBtn, #skipButton, #hintButton {
            font-family: 'Frank Ruhl Libre', serif !important;
            font-size: 1.3rem;
            padding: 14px 38px;
            border-radius: 10px;
            color: white;
            border: none;
            transition: background-color 0.3s, transform 0.2s;
        }

        .button:hover, #retryBtn:hover, #startBtn:hover, #nextStageBtn:hover, #skipButton:hover, #hintButton:hover {
            transform: scale(1.05);
        }

        .button-enabled {
            background-color: orange !important;
            cursor: pointer;
        }

        /* 驻转专 爪 砖转 - 专  抓 */
        .button:disabled,
        #retryBtn:disabled,
        #startBtn:disabled,
        #nextStageBtn:disabled,
        #skipButton:disabled,
        #hintButton:disabled {
            cursor: not-allowed;
            background-color: gray !important;
            opacity: 0.6;
        }
    </style>

    <meta charset="utf-8"/>
    <title> 转"</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            direction: rtl;
            font-family: 'Baloo 2', cursive;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: inherit;
            background-size: cover !important; /*  注 - 转 cover */
            background-repeat: no-repeat !important;
            background-position: center center !important;
            opacity: 1;
            z-index: -1;
            pointer-events: none;
        }

        #startScreen, #stageIntro, #quizContainer, #failScreen, #successScreen, #endScreen {
            display: none; /*  住 住转专 专专转  */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.5rem;
            background: linear-gradient(to right, #4CAF50, #2E8B57);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        :root {
            --quiz-width: 860px;
        }

        #questionText {
            font-size: 2.3rem;
            color: #0d47a1;
            font-weight: bold;
            margin: 12px 0 24px 0;
            width: var(--quiz-width);
            max-width: 98vw;
            margin-right: auto;
            margin-left: auto;
            background: linear-gradient(135deg, #f6fdff 90%, #e0f7fa 100%);
            border: 2.5px solid #80deea;
            border-radius: 22px;
            box-shadow: 0 1px 14px #b2ebf240;
            padding: 23px 17px;
            transition: background 0.23s;
            font-family: 'Varela Round', Arial, sans-serif !important;
        }

        .answer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 44px;
            justify-content: center;
            width: var(--quiz-width);
            max-width: 98vw;
            margin: 36px auto 36px auto;
        }

        .answer {
            font-family: 'Frank Ruhl Libre', serif !important;
            background: linear-gradient(120deg, #ffffff 94%, #e0f7fa 100%);
            border: 2px solid #b2ebf2;
            border-radius: 13px;
            padding: 12px 0;
            cursor: pointer;
            font-size: 1.85rem;
            min-height: 44px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.25s, color 0.17s, border 0.22s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            width: 96%;
            margin: 0 auto;
            color: #003b47;
        }

        .answer:hover {
            background: #e0f7fa;
        }

        .correct {
            background: #007e33 !important;
            color: #fff !important;
            border: 2px solid #006221 !important;
        }

        .wrong {
            background: #b71c1c !important;
            color: #fff !important;
            border: 2px solid #910d0d !important;
        }

        #progressBarContainer {
            width: var(--quiz-width);
            max-width: 98vw;
            height: 16px;
            background-color: #c8e6c9;
            border-radius: 7px;
            margin: 16px auto 18px auto;
            overflow: hidden;
            box-shadow: 0 1px 8px rgba(0, 172, 193, 0.12);
        }

        #progressBar {
            height: 100%;
            width: 100%;
            background-color: #2e7d32;
            transition: width 1s linear, background-color 0.5s ease;
        }

        #dashboard {
            width: var(--quiz-width);
            max-width: 98vw;
            margin: 0 auto 12px auto;
            background: #0097a7;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 13px 0;
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.17);
            font-family: 'Frank Ruhl Libre', serif !important;
        }

        #correctAnswersInfo {
            margin-top: 4px;
            font-size: 1.16rem;
            font-weight: normal;
            color: #fffbe2;
            text-shadow: 0 1px 2px #01579b55;
            font-family: 'Frank Ruhl Libre', serif !important;
        }

        #skipWrapper {
            margin: 10px auto 0;
            width: var(--quiz-width);
            max-width: 98vw;
            text-align: center;
        }

        #skipButton {
            padding: 11px 22px;
            font-size: 1.09rem;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.19);
            margin-bottom: 10px;
            width: 52%;
            min-width: 180px;
            max-width: 350px;
        }

        #skipButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #failScreen h2 {
            font-size: 3.1rem;
            color: #f44336;
            text-shadow: 0 2px 10px #fff, 0 1px 4px #f44336;
            font-family: 'Baloo 2', cursive;
        }

        #failScreen #failText {
            font-size: 2rem;
            margin: 22px 0 28px 0;
            color: #333;
            background: rgba(255, 255, 255, 0.83);
            padding: 20px 36px;
            border-radius: 24px;
            box-shadow: 0 1px 12px #f443363d;
            font-family: 'Baloo 2', cursive;
        }

        #failScreen #retryBtn {
            font-size: 2.2rem;
            padding: 19px 66px;
            background: linear-gradient(to right, #00bcd4, #2196f3);
            color: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 10px #2196f34a;
            font-family: 'Baloo 2', cursive;
        }

        #successScreen h2 {
            font-size: 3.1rem;
            color: #ff9800;
            font-weight: bold;
            text-shadow: 0 2px 10px #fff, 0 1px 4px #ff9800;
            font-family: 'Baloo 2', cursive;
            margin-bottom: 24px;
        }

        #successScreen #nextStageBtn {
            font-size: 2.2rem;
            padding: 19px 66px;
            background: linear-gradient(to right, #ff9800, #ffb347);
            color: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 10px #ff980054;
            font-family: 'Baloo 2', cursive;
        }

        #endScreen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: transparent;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        #endScreen .end-title, #endScreen .end-subtitle, #endScreen .end-congrats, #endScreen .button {
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        #user-info-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 4000;
            direction: ltr;
        }
        
        #currency-bar {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        #coin-icon {
            width: 30px;
            height: 30px;
            margin-left: 5px;
        }

        #coin-display {
            font-family: 'Rubik', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #d4af37;
            margin-left: 10px;
        }
        
        #avatar-banner {
            margin-top: 10px;
            background: rgba(0, 51, 102, 0.5);
            border-radius: 12px;
            padding: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid rgba(255, 255, 255, 0.7);
            height: 120px;
            transition: width 0.3s;
        }

        #user-avatar {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
            border: none;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 5000;
            display: flex;
            justify-content: center;
            align-items: center;
            direction: rtl;
        }
        
        .overlay-content {
            background: linear-gradient(135deg, #eef9ff, #d1ecf9);
            padding: 25px 30px;
            border: 1px solid #bce2f5;
            width: 90%;
            max-width: 650px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            font-family: 'Alef', sans-serif;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        }
        
        .overlay-content h2 {
            font-family: 'Frank Ruhl Libre', serif;
            font-size: 2.8rem;
            color: #003366;
        }

        .overlay-content h3 {
             font-family: 'Alef', sans-serif;
             font-size: 1.5rem;
             color: #333;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            left: 20px;
            color: #aaa;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #333;
        }

        #store-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 25px;
            margin-top: 20px;
            padding: 10px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .store-item {
            background-color: #fff;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        .store-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 100, 255, 0.3);
            border-color: #007bff;
        }
        
        .store-item img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #003366;
        }

        .item-price {
            font-weight: bold;
            margin-top: 8px;
            color: #d4af37;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        .item-price img {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            margin-bottom: 0;
        }

    </style>
    <script>
        document.fonts.ready.then(function () {
            document.body.style.visibility = "visible";
        });
    </script>
    <link href="favicon.svg" rel="icon" type="image/svg+xml"/>
    <link href="favicon.png" rel="alternate icon" type="image/png"/>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-74G3G1VJHX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-74G3G1VJHX');
    </script>
</head>
<body>

<div id="welcomeBanner">
    专 <br> 转状
</div>
<div id="authOverlay"
     style="display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:4000;background:rgba(255,255,255,0.93);">
    <iframe id="authFrame" src="" style="width:100vw;height:100vh;border:none;"></iframe>
</div>

<div id="user-info-container" style="display: none;">
    <div id="currency-bar" onclick="openStore()">
        <span id="coin-display">0</span>
        <img src="images/coin-icon.png" id="coin-icon" alt="注转">
    </div>
    <div id="avatar-banner">
        <img src="images/default-avatar.png" id="user-avatar" alt="住 砖">
    </div>
</div>
<div id="store-overlay" class="overlay" style="display:none;">
    <div class="overlay-content">
        <span class="close-btn" onclick="closeStore()">&times;</span>
        <h2>转 住</h2>
        <h3>砖 : <span id="store-coin-display">0</span></h3>
        <hr>
        <div id="store-items">
        </div>
    </div>
</div>

<button id="muteButton" onclick="toggleMute()"
        style="position: fixed; top: 12px; left: 12px; z-index: 2000; background: #ffffffcc; border: 1px solid #999; padding: 6px 12px; font-size: 0.95rem;font-family: 'Frank Ruhl Libre', serif; border-radius: 8px; cursor: pointer;">
     砖转拽
</button>
<div id="startScreen">
    <button class="button" id="startBtn" onclick="openAuthBanner()">转</button>
</div>

<div id="stageIntro">
    <iframe
            src="banner-animation/index.html"
            id="bannerIframe"
            style="width: 100%; height: 500px; border: none; position: relative; margin-top: 30px; z-index: 10;"
            loading="lazy">
    </iframe>
</div>
<div id="quizContainer">
    <div id="questionText"></div>
    <div class="answer-grid" id="answers"></div>
    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>
    <div id="skipWrapper">
        <button disabled="" id="skipButton" onclick="skipQuestion()"> 砖 (50 拽转)</button>
    </div>
    <div id="dashboard">
        <div id="quizInfo">
            砖: <span id="stageNum">1</span> |
            砖: <span id="questionNum">1</span> 转 10 |
            拽: <span id="scoreCount">0</span> |
             转专: <span id="timeLeft">20</span> 砖转
        </div>
        <div id="correctAnswersInfo"></div>
    </div>
</div>
<div id="failScreen">
    <h2 id="failTitle">
         注专转
    </h2>
    <div id="failText">
        砖 注专 砖  爪专 注转 驻转 转砖注 转砖转 转.<br/> 住 砖.
    </div>
    <button class="button" id="retryBtn" onclick="retryStage()">砖拽 砖</button>
</div>
<div id="successScreen">
    <canvas id="fireworksCanvas" style="display:none;"></canvas>
    <h2 id="successTitle">
        注专转 爪 转 砖 <span id="successStageNum"></span>
    </h2>
    <button class="button" id="nextStageBtn" onclick="goToNextStage()">注专 砖 </button>
</div>
<div id="endScreen">
    <canvas id="endFireworksCanvas"></canvas>
    <div class="end-title">住转 爪!</div>
    <div class="end-subtitle">专 砖转 转 转状!</div>
    <div class="end-congrats"> !</div>
    <button class="button" onclick="restartQuiz()">专 转</button>
</div>
<script>
    // Global variables for game state not saved to DB
    let stage = 1, current = 0, correct = 0, score = 0, questions = [], timer, timeLeft;

    // Placeholder functions in case sound_manager.js is not loaded
    if (typeof playIntroMusic === 'undefined') {
        function playIntroMusic() {}
        function stopAllSounds() {}
        function playGameMusic() {}
        function playSuccessSound() {}
        function playFailSound() {}
    }

    function setBackgroundOpacity(val) {
        let styleEl = document.getElementById("dynamicBgOpacity");
        if (!styleEl) {
            styleEl = document.createElement("style");
            styleEl.id = "dynamicBgOpacity";
            document.head.appendChild(styleEl);
        }
        styleEl.textContent = `body::before { opacity: ${val} !important; }`;
    }

    setBackgroundOpacity(1);
    
    const storeItems = [
        {name: '专', price: 100, image: 'images/lion-avatar.png'},
        {name: '砖专', price: 150, image: 'images/eagle-avatar.png'},
        {name: '', price: 200, image: 'images/star-avatar.png'},
        {name: '转专', price: 300, image: 'images/crown-avatar.png'}
    ];

    function alignAvatarBannerWidth() {
        const currencyBar = document.getElementById('currency-bar');
        const avatarBanner = document.getElementById('avatar-banner');
        if (currencyBar && avatarBanner) {
            const currencyBarWidth = currencyBar.offsetWidth;
            avatarBanner.style.width = currencyBarWidth + 'px';
        }
    }

    function updateScore(change) {
        score += change;
        if (score < 0) score = 0;
        document.getElementById("scoreCount").textContent = score;
        
        const skipBtn = document.getElementById("skipButton");
        if (skipBtn) {
            skipBtn.disabled = score < 50;
        }
        localStorage.setItem('userScore', score);
    }

    // These functions are now globally available but defined in the module
    // This makes them callable from onclick attributes
    window.openStore = () => window.firebase_store.openStore();
    window.closeStore = () => window.firebase_store.closeStore();
    window.buyItem = (item) => window.firebase_store.buyItem(item);


    function updateBackground() {
        document.body.style.backgroundImage = `url('backgrounds/stage${stage}.jpg')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundRepeat = 'no-repeat';
        document.body.style.backgroundPosition = 'center center';
        document.body.style.backgroundAttachment = 'fixed';
    }

    function showStartScreen() {
        document.getElementById('user-info-container').style.display = 'none';
        setBackgroundOpacity(1);
        document.body.style.backgroundImage = "url('backgrounds/main.jpg')";
        document.getElementById('startScreen').style.display = 'flex';
        document.getElementById('stageIntro').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'none';
        document.getElementById('failScreen').style.display = 'none';
        document.getElementById('successScreen').style.display = 'none';
        document.getElementById('endScreen').style.display = 'none';
        playIntroMusic();
    }

    function showStageIntro() {
        document.getElementById('user-info-container').style.display = 'block';
        window.firebase_store.loadUserData(); 
        
        setTimeout(alignAvatarBannerWidth, 50);

        var bannerIframe = document.getElementById('bannerIframe');
        if (bannerIframe) {
            bannerIframe.src = '';
            setTimeout(() => { bannerIframe.src = 'banner-animation/index.html'; }, 50);
        }
        if (document.getElementById('welcomeBanner')) {
            document.getElementById('welcomeBanner').classList.add('hide');
        }
        updateBackground();
        stopAllSounds();
        playGameMusic();
        setBackgroundOpacity(1);
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('stageIntro').style.display = 'flex';
        document.getElementById('quizContainer').style.display = 'none';
    }

    function startQuiz() {
        updateBackground();
        stopAllSounds();
        playGameMusic();
        setBackgroundOpacity(0.75);
        document.getElementById('stageIntro').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'flex';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('skipButton').style.display = 'inline-block';
        loadStage();
    }

    function loadStage() {
        fetch(`${stage}.json`).then(res => res.json()).then(data => {
            shuffleArray(data);
            questions = data.slice(0, 10);
            current = 0;
            correct = 0;
            showQuestion();
        });
    }

    function showQuestion() {
        let isAnswerLocked = false;
        if (current >= 10) {
            document.getElementById('skipButton').style.display = 'none';
            correct >= 9 ? showSuccessScreen() : showFailScreen();
            return;
        }

        const q = questions[current];
        shuffleQuestionAnswers(q);
        document.getElementById('questionText').textContent = q.question;
        const answersDiv = document.getElementById('answers');
        answersDiv.innerHTML = '';
        q.options.forEach((opt, i) => {
            const btn = document.createElement('div');
            btn.className = 'answer';
            btn.textContent = opt;
            btn.onclick = () => {
                if (isAnswerLocked) return;
                isAnswerLocked = true;
                clearInterval(timer);
                const isCorrect = i === q.correct;
                btn.classList.add(isCorrect ? 'correct' : 'wrong');

                if (isCorrect) {
                    playSuccessSound();
                    updateScore(5);
                    window.firebase_store.updateCoins(timeLeft);
                    correct++;
                } else {
                    playFailSound();
                    updateScore(-5);
                }

                setTimeout(() => {
                    current++;
                    showQuestion();
                }, 800);
            };
            answersDiv.appendChild(btn);
        });
        startTimer();
        updateDashboard();
    }

    function skipQuestion() {
        if (score >= 50) {
            clearInterval(timer);
            updateScore(-50);
            correct++;
            current++;
            showQuestion();
        }
    }

    function startTimer() {
        clearInterval(timer);
        if (stage <= 3) timeLeft = 20;
        else if (stage <= 6) timeLeft = 15;
        else timeLeft = 12;
        const initialTime = timeLeft;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '100%';
        progressBar.style.backgroundColor = '#2e7d32';
        document.getElementById('timeLeft').textContent = timeLeft;
        timer = setInterval(() => {
            timeLeft--;
            document.getElementById('timeLeft').textContent = timeLeft;
            progressBar.style.width = ((timeLeft / initialTime) * 100) + '%';
            if (timeLeft <= 5) progressBar.style.backgroundColor = '#f44336';
            if (timeLeft <= 0) {
                clearInterval(timer);
                updateScore(-5);
                current++;
                showQuestion();
            }
        }, 1000);
    }

    function getCorrectText(n) {
        if (n === 0) return ' 转砖转 转';
        if (n === 1) return '1 转砖 ';
        return `${n} 转砖转 转`;
    }

    function updateDashboard() {
        document.getElementById("stageNum").textContent = stage;
        document.getElementById("questionNum").textContent = current + 1;
        document.getElementById("scoreCount").textContent = score;
        document.getElementById('correctAnswersInfo').textContent = getCorrectText(correct);
    }

    function showFailScreen() {
        setBackgroundOpacity(1);
        clearInterval(timer);
        document.getElementById('quizContainer').style.display = 'none';
        document.getElementById('failScreen').style.display = 'flex';
        playIntroMusic();
    }

    let successTimeout = null;

    function showSuccessMessage() {
        const message = document.getElementById('successMessage');
        message.style.display = 'block';
        if (successTimeout) clearTimeout(successTimeout);
        successTimeout = setTimeout(() => {
            message.style.display = 'none';
        }, 5000);
    }

    function retryStage() {
        if (successTimeout) clearTimeout(successTimeout);
        document.getElementById('successMessage').style.display = 'none';
        clearInterval(timer);
        stopAllSounds();
        playGameMusic();
        setBackgroundOpacity(0.75);
        document.getElementById('failScreen').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'flex';
        loadStage();
    }

    function showSuccessScreen() {
        setBackgroundOpacity(1);
        clearInterval(timer);
        document.getElementById('quizContainer').style.display = 'none';
        document.getElementById('successScreen').style.display = 'flex';
        playIntroMusic();
        document.getElementById('successStageNum').textContent = stage;
        showSuccessMessage();
    }

    function goToNextStage() {
        if (successTimeout) clearTimeout(successTimeout);
        document.getElementById('successMessage').style.display = 'none';

        stage++;
        if (stage > 10) {
            showEndScreen();
            return;
        }
        document.getElementById('successScreen').style.display = 'none';
        showStageIntro();
    }

    function shuffleQuestionAnswers(q) {
        const optionsWithFlag = q.options.map((opt, index) => ({ text: opt, isCorrect: index === q.correct }));
        for (let i = optionsWithFlag.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [optionsWithFlag[i], optionsWithFlag[j]] = [optionsWithFlag[j], optionsWithFlag[i]];
        }
        q.options = optionsWithFlag.map(o => o.text);
        q.correct = optionsWithFlag.findIndex(o => o.isCorrect);
    }

    function showEndScreen() {
        document.getElementById('user-info-container').style.display = 'none';
        setBackgroundOpacity(1);
        clearInterval(timer);
        document.body.style.backgroundImage = "url('backgrounds/end.jpg')";
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('stageIntro').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'none';
        document.getElementById('failScreen').style.display = 'none';
        document.getElementById('successScreen').style.display = 'none';
        document.getElementById('endScreen').style.display = 'flex';
    }

    function restartQuiz() {
        stage = 1;
        correct = 0;
        current = 0;
        score = 0;
        localStorage.removeItem('userScore');
        updateScore(0);
        setBackgroundOpacity(1);
        clearInterval(timer);
        showStartScreen();
    }
        
    showStartScreen();
</script>

<script src="sound_manager.js"></script>

<script>
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
</script>

<script>
let isMuted = false;
function toggleMute() {
  if (typeof sounds === 'undefined' || sounds === null) {
      console.error("Mute Error: The 'sounds' object is not available.");
      return;
  }
  isMuted = !isMuted;
  const button = document.getElementById("muteButton");
  button.innerText = isMuted ? " 驻注 爪" : " 砖转拽";
  Object.values(sounds).forEach(sound => {
    if (sound && typeof sound.muted === 'boolean') {
        sound.muted = isMuted;
    }
  });
}
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyABKn0GfHYi_1UG_0sfSn68CNNz4Q9nS7g",
    authDomain: "hidon1-e4c91.firebaseapp.com",
    projectId: "hidon1-e4c91",
    storageBucket: "hidon1-e4c91.appspot.com",
    messagingSenderId: "411517496015",
    appId: "1:411517496015:web:2d9c176783d062110465ba",
    measurementId: "G-FWTSZNY72T"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  let currentUser = null;

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    // When auth state changes, re-load user data if they are logged in
    // This is useful if the user logs in mid-game
    if (user && document.getElementById('user-info-container').style.display === 'block') {
        window.firebase_store.loadUserData();
    }
  });
  
  // --- START: NEW CENTRALIZED LOGIC ---

  // All state and functions related to DB are now in one object
  const firebase_store = {
    coins: 0,
    userAvatar: 'images/default-avatar.png',

    async loadUserData() {
        if (!currentUser) {
            this.coins = parseInt(localStorage.getItem('userCoins') || '0', 10);
            this.userAvatar = localStorage.getItem('userAvatar') || 'images/default-avatar.png';
        } else {
            const userRef = ref(db, 'users/' + currentUser.uid);
            try {
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    this.coins = data.coins || 0;
                    this.userAvatar = data.avatar || 'images/default-avatar.png';
                } else {
                    this.coins = 0;
                    this.userAvatar = 'images/default-avatar.png';
                    this.saveUserDataToDB(); // Initial save for new user
                }
            } catch(error) {
                console.error("DB Load Error:", error);
                this.coins = parseInt(localStorage.getItem('userCoins') || '0', 10);
                this.userAvatar = localStorage.getItem('userAvatar') || 'images/default-avatar.png';
            }
        }
        
        // Update UI
        document.getElementById("coin-display").textContent = this.coins;
        document.getElementById("store-coin-display").textContent = this.coins;
        document.getElementById('user-avatar').src = this.userAvatar;
        
        // Update global score
        window.score = parseInt(localStorage.getItem('userScore') || '0', 10);
        window.updateScore(0);
    },

    saveUserDataToDB() {
        if (!currentUser) return; 

        const userRef = ref(db, 'users/' + currentUser.uid);
        set(userRef, {
            coins: this.coins,
            avatar: this.userAvatar
        }).catch(error => console.error("DB Save Error:", error));
    },
    
    updateCoins(change) {
        this.coins += change;
        if (this.coins < 0) this.coins = 0;
        
        // Update UI
        document.getElementById("coin-display").textContent = this.coins;
        document.getElementById("store-coin-display").textContent = this.coins;
        
        localStorage.setItem('userCoins', this.coins);
        this.saveUserDataToDB();
    },

    buyItem(item) {
        if (this.coins >= item.price) {
            this.updateCoins(-item.price);
            
            this.userAvatar = item.image;
            document.getElementById('user-avatar').src = this.userAvatar;
            localStorage.setItem('userAvatar', this.userAvatar);
            this.saveUserDataToDB();
            
            alert(`拽转 转 住 -${item.name}!`);
            this.closeStore();
        } else {
            alert('  住驻拽 注转  拽转 转 .');
        }
    },
    
    openStore() {
        window.populateStore();
        document.getElementById('store-overlay').style.display = 'flex';
    },

    closeStore() {
        document.getElementById('store-overlay').style.display = 'none';
    },

    populateStore() {
        const itemsContainer = document.getElementById('store-items');
        itemsContainer.innerHTML = '';
        window.storeItems.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'store-item';
            itemDiv.innerHTML = `<img src="${item.image}" alt="${item.name}"><p class="item-name">${item.name}</p><p class="item-price">${item.price} <img src="images/coin-icon.png" alt="注"></p>`;
            itemDiv.onclick = () => this.buyItem(item); // Note: calls this.buyItem
            itemsContainer.appendChild(itemDiv);
        });
    }
  };
  
  // Expose the store object to the global window for access from other scripts
  window.firebase_store = firebase_store;
  // --- END: NEW CENTRALIZED LOGIC ---

  function openAuthBanner() {
    document.getElementById('welcomeBanner').classList.add('hide');
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('authOverlay').style.display = 'block';
    document.getElementById('authFrame').src = "auth.html";
  }

  window.addEventListener("message", function(event) {
    if(event.data === "authComplete") {
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('authFrame').src = "";
      showStageIntro();
    }
  });
  window.openAuthBanner = openAuthBanner;
</script>
  
</body>
</html>
